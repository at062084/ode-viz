name: Build and Deploy Apache Superset

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'

env:
  IMAGE_NAME: superset-app
  COMPOSE_FILE: docker-compose.yml

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Using self-hosted runner on PULPHOST

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          echo "ğŸ”¨ Building Docker image..."
          docker build -t ${{ env.IMAGE_NAME }}:latest .
          echo "âœ… Docker image built successfully"

      - name: Deploy with Docker Compose
        run: |
          echo "ğŸš€ Deploying with Docker Compose..."

          # Create .env file if it doesn't exist
          if [ ! -f .env ]; then
            cp .env.example .env
            echo "âš ï¸  Created .env from .env.example"
            echo "ğŸ“ Please update .env with your configuration if needed"
          fi

          # Stop existing containers
          docker compose down

          # Start new containers
          docker compose up -d

          # Show status
          echo "ğŸ“Š Container status:"
          docker compose ps

      - name: Verify deployment
        run: |
          echo "â³ Waiting for services to be healthy..."
          sleep 10

          echo "ğŸ“Š Final status:"
          docker compose ps

          echo "âœ… Deployment completed!"
          echo "ğŸŒ Access Superset at: http://localhost:8088"
